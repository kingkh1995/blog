# [首页](/blog/)

> **分布式系统**

***

## 分布式系统需要考虑的问题

1. 安全；
2. 监控、告警；
3. 单点故障、系统弹性；
4. 网络带宽；
5. 客户端适配；
6. 网络可靠性；
7. 延时；
8. 传输成本（传输协议）。

***

## 分布式ID生成

- **数据库自增**：最常用的方案，存在数据库单点问题；
- **数据库号段模式**：优点是减少数据库压力，缺点是ID非绝对递增，且仍然存在单点问题；
- **不同机器使用不同的初始值和相同的步长自增**：优点是现有功能即可轻松实现，缺点是ID非绝对递增、ID资源浪费严重；
- **UUID**：实现简单、缺点是安全性不足、有重复的可能、是字符串ID；
- **雪花算法**：实现简单、性能好、灵活可改造，缺点是强依赖机器时钟、同一时刻不同机器间的ID非严格递增；
- **ID生成服务器**：如使用Redis生成，优点是支持批量生成，缺点是对服务可靠性要求高。

***

## 分布式理论

### CAP

一个系统不可能同时满足一致性（C: Consistency）、可用性（A: Availability）和分区容错性（P: Partition tolerance），最多只能同时满足两项。

P是分布式系统最基本要求，即分布式系统不能因为出现网络分区而导致A和C无法保证，所以分布式系统应该选择侧重A或者C，**ZooKeeper和Consul保证CP，Eruka保证AP，Nacos支持AP（默认）和CP**。

### Base

Base Available、（基本可用）Sofe state（软状态）、Eventually consistent（最终一致性），核心思想是即使无法做到强一致性，也应该使系统做到最终一致性。

### 最终一致性的五种实现

- 因果一致性：进程对数据的更新会通知到与其有因果关系的其他线程，不会发生更新丢失；
- 读已之所写：进程更新完数据之后，总是能访问到最新值而不是旧值；
- 会话一致性：保证在同一个会话中实现‘读已之所写’；
- 单调读一致性：一旦进程读取到数据项的某个值后，后续都不应该读取到旧的值；
- 单调写一致性：保证同一个进程写操作被顺序执行。

***

## 分布式事务解决方案

### 刚性事务（强一致性）

- **2PC**：二阶段提交，**是同步阻塞协议**，第一阶段有超时机制，第二阶段则不允许失败，只能不断重试。如根据XA规范实现的JTA，需要一个的协调者，分为准备和提交两阶段。
  - 同步阻塞：会因为某个参与者而导致所有参与者阻塞；
  - 单点：协调者为单点，一旦故障会导致资源一直锁定；
  - 脑裂：提交阶段，如只有部分参与者收到了提交请求，会出现数据不一致。

- **3PC**：三阶段提交，分为准备、预提交和提交三个阶段，准备阶段是询问参与者是否有条件接受事务，预提交阶段只记录日志不提交事务，如超时则中断事务，提交阶段如果超时会提交事务。**暂无实现方案，因为并没有解决数据可能不一致的问题**。
  - 阻塞延后：预提交阶段判断参与者无法接受事务则立即中断；
  - 单点解决：第二阶段和第三阶段都有超时机制；
  - 脑裂依旧存在：第三阶段如果部分参与者未收到abort请求会在超时后提交。
  
### 柔性事务
- **TCC**：思想上同2PC，还需要一个TM（事务管理者）来记录全局事务的状态，**由于Confirm和Cancel都可能重试，保证操作的幂等性是关键**。
- **Saga**：每个事务都有执行模块和补偿模块，补偿模块分为向前补偿和向后补偿，也需要保证幂等性，**缺点是不满足一致性**。
- **消息最终一致性**：发送事务消息成功后提交本地事务，优点是削峰填谷，缺点是要求消息组件可靠性、不满足一致性、无法回滚；
- **本地消息表**：属于消息最终一致性方案的变体，将事务消息保存在本地消息表中和本地事务一起提交，同时后续补偿保证消息被成功消费，优点是可靠性能得到保障，缺点是实现复杂。
- **最大努力通知**：本地事务提交后发送消息，由最大努力通知服务消费消息并记录，然后调用其他系统服务接口，并定时重试直到成功。

***

## 分布式一致性算法

### Paxos

强一致性，属于共识算法，无法解决拜占庭将军问题，缺点是角色过多，不容易实现。

- 角色：
  - Proposal：提案，即更新请求，提案编号N为自增值。
  - Proposer：负责帮客户端上交提案。
  - Acceptor：负责为提案投票，同时记录自己的投票历史。
  - Learner：负责记录通过的提案。

- 步骤：
  1. Propser准备一个编号为N的提案；
  2. Propser询问Acceptor是否接收过编号为N的提案，如果多数都没有接受过则进入下一步，否则本提案不被考虑；
  3. Propser向Acceptor发送真正的提案，Acceptor无条件同意从未接收过的提案，不同意比自己以前接收过的提案编号要小的提案，一旦提案被多数同意后进入下一步；
  4. 编号为N的提案通过，Propser向已接受了提案的Acceptor发送提交请求，向未接受的Acceptor发送提案要求他们强制接受；
  5. 最后Learner记录提案，并将结果返回客户端。

- 问题：假设存在多个Proposer，他们不断向Acceptor发出提案，还没等到上一个提案投票达到多数，下一个提案又来了，Acceptor接受了下一个提案后就会拒绝当前提案，于是所有提案都无法通过。

- 改进：只允许存在一个Proposer，称之为Leader，Acceptor只会处理最新的Leader发出的提案。

### Raft

是对Paxos算法的简化和改进，算法分为Leader选举和状态复制。

- 角色：
  - Leader：负责发出提案；发起心跳，响应客户端，创建日志，同步日志；
  - Follower：负责同意Leader发出的提案；接受Leader的心跳和日志同步数据，投票给Candidate。
  - Candidate：负责争夺Leader；临时角色复制，负责发起Leader竞选投票，由Follower转换。

- Leader选举：每个Follower都持有一个定时器，当定时器截止集群中仍然没有Leader，则会声明自己为Candidate并竞选Leader，并发送消息给其他节点争取投票，获取多数支持的Candidate将称为第M任Leader（M为最新任期），Leader在任期间会不断给其他节点发送心跳，其他节点收到心跳后会将定时器重置并回复心跳。
  - 如果没有Candidate获取多数选票，他们将**随机延后一段时间**后重新发起投票。

- 状态复制：Leader接受到客户端的提案请求后，会将提案请求包含在发出的下一次心跳中，Follower接受到心跳后回复Leader，Leader在接受到多数回复后会确认提案并记录，然后回复客户端，Leader通知Follower确定提案并保存。

- 脑裂：如果发生脑裂，则非多数的子集群将无法确认提案，集群恢复之后，将只会接受最新任期的Leader的指挥，旧的Leader会退化成Follower。

### ZAB

大部分和raft相同，但状态复制的过程中，心跳是由Follower向Leader发送。

### Gossip

弱一致性算法，Redis集群使用Gossip协议传播节点的状态信息。没有角色之分，节点接受到数据变更，会随机传播给其他节点，收到变更后的节点再重复此过程，直到所有节点都被感染。

***

## 脑裂问题

### Redis

指某个master突然脱离了集群网络导致出现了分区，则从节点会被升级为master，出现脑裂。

- 设置最小从节点数量，至少是1；
- 设置最小数据复制和同步的延迟；

### ZooKeeper
1. 集群网络出现异常导致集群被分隔，多数派的子集群选举出了自己的leader，出现脑裂；
2. leader假死后，集群选举出新的leader，出现脑裂。

- 提案必须要超过半数节点投票才能确认，所以少数派的子集群永远不会成功确认提案；
- 旧leader恢复后向followers发出写请求会被拒绝，因为follower只接受最新选举出来的leader的请求。

### Nacos

使用Raft协议解决脑裂问题，与ZAB协议基本相同。

***

## 分布式协调服务

#### 使用场景

- 系统A发送消息后，在ZooKeeper指定节点上注册监听器，当消息被系统B消费后，系统B修改节点的值，ZooKeeper通知到系统A。
- 主机器注册临时节点到ZooKeeper，备用节点注册该节点的监听器，一旦主节点故障，ZooKeeper立马通知切换到备用节点。

#### 特点

- 顺序一致性：从同一客户端发起的事务请求，最终将会严格地按照顺序被应用到 ZooKeeper 中去。
- 原子性：所有事务请求的处理结果在整个集群中所有机器上的应用情况是一致的，也就是说，要么整个集群中所有的机器都成功应用了某一个事务，要么都没有应用。
- 单一视图：无论客户端连到哪一个ZooKeeper服务器上，其看到的服务端数据模型都是一致的。
- 可靠性：一旦一次更改请求被应用，更改的结果就会被持久化，直到被下一次更改覆盖。
- 实时性：**仅能保证一段时间内最终一定会读到最新的数据。**

#### 组成

- znode：使用层次化的多叉树形式，一个节点都能保存数据，被称为znode，znode属性包括stat和data，分为容器节点（相当于文件夹）、持久节点、临时节点（生命周期随会话结束）和带ttl的临时节点，同时节点还可以是顺序节点。
- ACL：权限控制。
- Watcher：监听器，只能触发一次。
- Session：会话，可以视作一个TCP长连接，客户端通过定时发送心跳保持会话。

#### 集群

- Leader：为客户端提供读和写的服务，负责投票的发起和决议，更新系统状态。
- Follower：为客户端提供读服务，如果是写服务则转发给 Leader，参与选举过程中的投票。
- Observer：为客户端提供读服务，如果是写服务则转发给 Leader，不参与选举过程中的投票，也不参与“过半写成功”策略，可以在不影响写性能的情况下提升集群的读性能。

### Nacos

***