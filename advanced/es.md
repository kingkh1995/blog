# [首页](/blog/)

> **ElasticSearch**

***

## 概念

分布式、高性能、高可用、易拓展的非关系型数据。使用json方式存储文档。

- 群集：一个或多个节点（服务器）的集合，它们共同保存和管理整个数据集，并提供跨所有节点的联合索引和搜索功能，群集需要有唯一名称标识，默认情况下为“elasticsearch”。
- 节点：属于集群一部分的单个服务器，每个节点负责存储部分数据，并参与群集索引和搜索功能。　　
- 索引：等同于关系数据库中的“数据库”，有一个定义多种类型的映射。索引是逻辑名称空间，映射到一个或多个主分片，并且可以有零个或多个副本分片。
- 类型：是索引的逻辑类别/分区，等同于关系型数据库中的“表”。
- 文档：等同于关系数据库中的一行。索引中的每个文档可以具有不同的结构（字段），但是相同的字段应该具有相同的数据类型。

### 倒排索引

使用词项（term）来索引文档，text字段会被分词、规范化、去重及排序，底层结构是FST（类似于字典树，每个节点是一个哈希表，重复利用单词前缀和后缀，构建有向无环图），针对Post List（文档ID集合）也会有压缩策略，如使用Bitmap。

### 数据类型

- keyword：用于精确查找，不会被拆分，适用于排序、过滤、聚合等。
- text：用于全文检索，会被拆分，用于生成倒排索引。
- 数字：
- 日期：
- 数字范围：
- geo地理信息：

### 复杂数据类型

- Object：会被扁平的拆分为字段，如果是对象数组则会拆分为扁平数组字段。
- Nested：不会扁平化，会维持对象关系。
- Array：数组类型

### dynamic mapping

自动映射，可以不预先定义字段类型，插入文档时自动选择。

***

## 一致性方案

### 同步双写

先保证数据库或ES一定写入成功，之后的写入失败可以使用告警后人工处理等方式。
- 优点：实时性高；实现简单。
- 缺点：无法保证强一致性；性能较差。

### 异步双写

引入MQ，数据库或ES写入成功后发送消息（**一般是事务消息**），通过消费MQ实现异步写入；**存在写入顺序和消费顺序不一致的场景因为服务器之间无法保证顺序发送**，需要增加版本号比对（ES支持版本号对比），如果指定的版本号小于当前版本号则可以直接忽略。

- 优点：能保证最终一致性；性能高。
- 缺点：需要MQ组件，实现复杂；可能存在延时性问题；需要考虑写入顺序和消费顺序不一致的场景。

### Binlog同步方式

写入数据库后，使用Canal等组件监听数据库Binlog（可以使用MQ作为中间传输），之后写ES。

- 优点：数据库和ES代码解耦；性能最高；实现简单。
- 缺点：需要引入Binlog监听组件；Binlog解析有一定复杂度，一般只适合单表；可能存在延时性问题。

***

## 实现细节

### 文档索引流程

1. 客户端向集群中某个节点发送写请求；
2. 节点确定文档所属的主分片，转发到对应节点；
3. 写操作完成，主分片所在节点并行将请求转到持有副本分片的节点；
4. 副本分片节点写操作完成返回结果给主分片所在的节点；
5. 主分片所在的节点等待所有节点写入完成后返回节点给接受请求的节点；
6. 接受请求的节点向客户端返回结果。

### 文档搜索流程

1. 协调节点将读请求转发到索引的所有分片（主或副分片一个）；
2. 每个分片在本地查询，排序后将各自的结果返回到协调节点；
3. 协调节点汇总后进行全局排序；
4. 协调节点路由到文档对应的节点抓取数据，返回给客户端。

### 文档更新删除
文档创建后即是不可变，删除操作则会在对应段的.del文件中标记，段合并时不会写入删除的文档，被删除的文档依然会被查询到，但是会在结果中被过滤。每个文档都有一个内部版本号，更新时会重新创建新的文档，并将旧版本的文档设置为删除。

***

### 调优方案

- 控制索引的数据量大小，通过roll over API创建滚动索引；
- 定时对索引做force_merge，释放空间
- 合理设置分词方式，尽可能使用keyword；
- 合理的Mapping设置，是否需要检索、是否需要存储等等。

***